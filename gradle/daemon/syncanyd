NAME="Syncany daemon"
APPDIR=~/.config/syncany
CONTROLFILE=$APPDIR/daemon.ctrl
PIDFILE=$APPDIR/daemon.pid
LOGDIR=$APPDIR/logs
LOGFILE=$LOGDIR/daemon.log

get_pid() {
	if [ -e $PIDFILE ]; then
		echo $(cat $PIDFILE)
	else
		echo -1
	fi
}

get_realpath() {
    [ ! -f "$1" ] && return 1 # failure : file does not exist.
    [ -n "$no_symlinks" ] && local pwdp='pwd -P' || local pwdp='pwd' # do symlinks.
    echo "$( cd "$( echo "${1%/*}" )" 2>/dev/null; $pwdp )"/"${1##*/}" # echo result.
    return 0 # success
}

process_running() {
	ID=$(get_pid)
	if [ $ID -eq -1 ]; then
		echo 0
	elif [ -n $(ps -p$ID -opid=) ]; then
		echo 1
	else
		echo 0
	fi	
}

DAEMON=$(dirname $(get_realpath "$0"))/syncany
DAEMON_OPTS="--log=$LOGFILE daemon"
 
export PATH="${PATH:+$PATH:}/usr/sbin:/sbin"

mkdir -p $APPDIR
mkdir -p $LOGDIR

start() {
	RUNNING=$(process_running)
	
	echo -n "Starting daemon: "
	
	if [ $RUNNING -eq 1 ]; then
		echo "$NAME already running (pid $PID)"
	else
		nohup "$JAVACMD" "${JVM_OPTS[@]}" -classpath "$CLASSPATH" org.syncany.Syncany $DAEMON_OPTS > /dev/null 2>&1 &

		PID=-1
		TRIES=10
		
		while [ $RUNNING -eq 0 -a $TRIES -gt 0 ]; do
			RUNNING=$(process_running)
			echo -n "."
		
			PID=$(get_pid)
			TRIES=$(($TRIES-1))
			sleep 1
		done
		
		if [ $TRIES -eq 0 ]; then
			echo " Failed to start process. EXITING."
			echo "Failed command line: $ $DAEMON $DAEMON_OPTS"
			exit 2
		fi
		
		echo " $NAME (pid $PID)."
	fi
}

stop() {
	RUNNING=$(process_running)

	echo -n "Stopping daemon: "
	
	if [ $RUNNING -eq 0 ]; then
		echo "$NAME not running"
	else
		echo "shutdown" >> $CONTROLFILE
		
		TRIES=10
		while [ $RUNNING -eq 1 -a $TRIES -gt 0 ]; do
			RUNNING=$(process_running)
			echo -n "."
		
			TRIES=$(($TRIES-1))
			sleep 1
		done
		
		if [ $TRIES -eq 0 ]; then
			echo " Failed to stop process $PID. Try 'force-stop'. EXITING."
			exit 3
		fi
		
		echo " $NAME stopped."
	fi
}

force_stop() {
	RUNNING=$(process_running)

	echo "Force-stopping daemon: "

	if [ $RUNNING -eq 0 ]; then
		echo "$NAME not running"
	else
		kill -9 $PID
		
		RUNNING=$(process_running)
		
		sleep 1
			
		RUNNING=$(process_running)
		if [ $RUNNING -eq 1 ]; then
			echo "Failed to kill -9 $PID. EXITING."
		else 
			rm $PIDFILE 2> /dev/null
			rm $CONTROLFILE 2> /dev/null

			echo "Killed $NAME (pid $PID)."
		fi
	fi
}


status() {
	RUNNING=$(process_running)
	echo -n "Checking daemon: "$NAME
	
	if [ $RUNNING -eq 0 ]; then
		echo " not running"
	else
		echo " running (pid $PID)."
	fi
}

reload() {
	RUNNING=$(process_running)
	echo -n "Reloading daemon: "$NAME
	
	if [ $RUNNING -eq 0 ]; then
		echo " not running"
	else
		echo "reload" >> $CONTROLFILE
		echo "."
	fi
}

# Run main script
PID=$(get_pid)